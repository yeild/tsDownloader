<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ts视频合并下载器</title>
  <style>
    
/*    html {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }*/
html {
  font-size: 12px;
}

    .container {
      width: 480px;
      //background: linear-gradient(#3facff, #1f9eff);
    }
    p {
      margin: 0;
    }

    .row {
      padding: 6px 10px;
    }
    .label {
      display: inline-block;
      width: 70px;
      text-align: right;
    }
/*    .url-input {
      width: 240px;
      padding: 6px 8px;
      margin-left: 10px;
      border: 1px solid #c2c9c1;
      outline: none;
      resize:none
    }*/


    .info {
      border: 1px solid grey;
      height: 100px;
    }

  </style>
</head>
<body>
<div class="container">
  <div class="row">
    <label class="label">下载地址:</label>
    <input class="url-input" value="https://pl-ali.youku.com/playlist/m3u8?vid=XNDAwNDUxMzUyOA%3D%3D&type=flvhdv3&ups_client_netip=7d4674aa&utid=cfEEFNoeNkUCAW644spAMPsE&ccode=0502&psid=c4764aed156e607e8980010102e61ded&duration=6174&expire=18000&drm_type=1&drm_device=7&ups_ts=1550043795&onOff=0&encr=0&ups_key=f3ebf1bc8228e6757f9e239118314830" placeholder="请输入m3u8地址" id="m3u8Input"/>
  </div>
  <div class="row">
    <label class="label">文件名:</label>
    <input class="url-input" value="name" id="filename"/><span style="font-size: 16px">.ts</span>
  </div>
  <div class="row">
    <label class="label">保存路径:</label>
    <input class="url-input" readonly id="savePathInput"/>
    <button class="download-btn" id="chooseDirBtn">浏览</button>
    <button class="download-btn" id="downloadBtn">立即下载</button>
  </div>
  <div class="row" id="info">
    <p id="progressInfo" hidden>下载文件...(<span id="doneCount">0</span>/<span id="taskCount">0</span>)</p>
    <p id="failInfo" hidden>下载失败：<span id="failCount">0</span></p>
    <p id="finishInfo" hidden></p>
  </div>
  <div class="row" id="failList">

  </div>
</div>
<script>
const path = require('path')
const shell = require('electron').shell
const ipcRenderer = require('electron').ipcRenderer
const { resolve, download } = require('./download')
const querySelector = document.querySelector.bind(document)

let savePath = localStorage.getItem('savePath')
if (savePath) querySelector('#savePathInput').value = savePath

querySelector('#chooseDirBtn').onclick = function () {
  ipcRenderer.send('openDirectory')
}

ipcRenderer.on('savePath', function (event, path) {
  querySelector('#savePathInput').value = path
  localStorage.setItem('savePath', path)
})

document.addEventListener('click', function (e) {
  if (e.target.id == 'openDir'){
    console.log(querySelector('#savePathInput').value)
    shell.showItemInFolder(querySelector('#savePathInput').value)
  }
  if (e.target.id == 'openFile'){
    shell.openItem(path.resolve(querySelector('#savePathInput').value, 'name.ts'))
  }
})
querySelector('#downloadBtn').addEventListener('click', function () {
  resolve({
    m3u8: querySelector('#m3u8Input').value,
    savePath: querySelector('#savePathInput').value,
    filename: querySelector('#filename').value + '.ts'
  }).then(function (videoList) {
    querySelector('#taskCount').innerHTML = videoList.length
    querySelector('#progressInfo').removeAttribute('hidden')
    download({
      videoList,
      progress ({ doneCount, failCount }) {
        if (failCount > 0) {
          querySelector('#failCount').innerHTML = failCount
        }
        querySelector('#doneCount').innerHTML = doneCount
      },
      finish ({ doneCount, failCount }) {
        querySelector('#progressInfo').setAttribute('hidden', '')
        querySelector('#finishInfo').removeAttribute('hidden')
        const taskCount = videoList.length
        if (failCount === taskCount) {
          querySelector('#info').innerHTML = '下载失败：链接已失效'
        } else if (doneCount < taskCount) {
          querySelector('#info').innerHTML = `下载完成，成功${doneCount}, 失败${failCount}, 是否重新下载失败文件？<a href="#">是</a>/ <a href="#">否，直接合并</a>`
        } else {
          querySelector('#info').innerHTML = `下载完成。<a href="#" id="openFile">打开</a> <a href="#" id="openDir">打开文件夹</a>`
        }
      }
    })
  })
})
</script>
</body>
</html>